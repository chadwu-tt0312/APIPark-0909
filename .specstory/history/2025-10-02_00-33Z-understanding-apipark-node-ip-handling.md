<!-- Generated by SpecStory -->

<!-- cursor Session 63050573-8017-4b86-a7b4-009797f72563 (2025-10-02 00:33Z) -->

# Understanding APIPark node IP handling (2025-10-02 00:33Z)

_**User (2025-10-02 00:38Z)**_

- APIPark 啟動後 是如何判斷 Apinto 的 ip 並寫入 cluster_node table ?
- 從前端輸入新的Node IP+Port (EX: 10.4.0.148:9400) 的執行流程有哪些? 為何會出現服務地址是 "10.4.0.148:80" ? Port 不是應該都設定為8099 ?

---

_**Assistant (default)**_

我來幫您分析 APIPark 中 Apinto 節點 IP 判斷和寫入流程，以及前端新增節點時的執行流程。讓我先查看相關的程式碼。


---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "APIPark 如何判斷 Apinto IP 並寫入 cluster_node table" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `service/cluster/cluster.go` | L113-188 |
| `quick-start.sh` | L1239-1301 |
| `scripts/resource/init_config.sh` | L80-135 |
| `scripts/resource/init_config.sh` | L241-292 |
| `k8s_helm/apipark/values.yaml` | L194-258 |
| `quick-start.sh` | L1130-1182 |
| `module/cluster/impl.go` | L51 |
| `k8s_helm/apipark/templates/configmap.yaml` | L61-97 |
| `quick-start.sh` | L1442-1498 |
| `quick-start.sh` | L1179-1245 |
| `quick-start.sh` | L1094-1136 |
| `k8s_helm/apipark/templates/NOTES.txt` | L37 |
| `quick-start.sh` | L1649-1707 |
| `k8s_helm/EXTERNAL_ACCESS.md` | L84 |
| `stores/cluster/model.go` | L33-52 |

</details>

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "cluster_node table 寫入流程" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `service/cluster/cluster.go` | L113-188 |
| `service/cluster/cluster.go` | L264-354 |
| `stores/cluster/model.go` | L39 |
| `stores/cluster/store.go` | L34 |
| `service/cluster/cluster.go` | L183-238 |
| `stores/cluster/model.go` | L33-52 |
| `service/plugin-cluster/iml.go` | L152-210 |
| `service/cluster/model.go` | L41 |
| `module/cluster/impl.go` | L51 |
| `service/cluster/cluster.go` | L44 |
| `module/cluster/dto/output.go` | L50 |
| `service/cluster/cluster.go` | L346-421 |
| `service/plugin-cluster/iml.go` | L84 |
| `stores/cluster/cluster.go` | L42 |
| `frontend/packages/core/src/pages/partitions/PartitionInsideClusterNode.tsx` | L8-93 |

</details>

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "前端新增 Node IP Port 執行流程" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `controller/service/iml.go` | L482-553 |
| `k8s_helm/EXTERNAL_ACCESS.md` | L84 |
| `k8s_helm/apipark/templates/NOTES.txt` | L37 |
| `frontend/packages/core/src/const/system/const.tsx` | L371-418 |
| `scripts/resource/docker_run_new.sh` | L78 |
| `k8s_helm/fix-external-access.sh` | L76 |
| `k8s_helm/apipark/values.yaml` | L88-199 |
| `frontend/packages/core/package.json` | L23 |
| `quick-start.sh` | L1130-1182 |
| `quick-start.sh` | L1582-1655 |
| `frontend/packages/core/src/pages/mcpService/AddMcpKey.tsx` | L16-98 |
| `controller/service/iml.go` | L549-619 |
| `frontend/package.json` | L57 |
| `quick-start.sh` | L1179-1245 |
| `k8s_helm/apipark/values.yaml` | L194-258 |

</details>

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "服務地址 port 80 8099 設定" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `k8s_helm/apipark/templates/apinto-service.yaml` | L27 |
| `k8s_helm/apipark/values.yaml` | L88-199 |
| `k8s_helm/EXTERNAL_ACCESS.md` | L84 |
| `quick-start.sh` | L1442-1498 |
| `k8s_helm/apipark/values.yaml` | L194-258 |
| `scripts/docker-compose.yml` | L60-95 |
| `k8s_helm/apipark/templates/configmap.yaml` | L61-97 |
| `k8s_helm/apipark/templates/NOTES.txt` | L37 |
| `scripts/resource/config.yml.tpl` | L18 |
| `docker-compose.yml` | L57 |
| `k8s_helm/apipark/templates/apinto-deployment.yaml` | L68 |
| `docker-compose.yml` | L157-234 |
| `main.go` | L63 |
| `k8s_helm/fix-external-access.sh` | L73-122 |
| `install.log` | L692-696 |

</details>

---

現在讓我查看更詳細的程式碼，特別是關於 Apinto 節點資訊獲取和前端新增節點的流程：


---

Tool use: **read_file**

Read file: gateway/admin/admin.go

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "admin.Admin(address).Info 如何獲取 Apinto 節點資訊" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `gateway/admin/admin.go` | L25 |
| `gateway/admin/client.go` | L8 |
| `gateway/admin/model.go` | L15 |
| `gateway/admin/http.go` | L68 |
| `gateway/apinto/dynamic.go` | L69 |
| `gateway/apinto/client.go` | L83 |
| `gateway/apinto/application.go` | L50-93 |
| `gateway/admin/util.go` | L16 |
| `gateway/apinto/application.go` | L54 |
| `gateway/apinto/plugin.go` | L44 |
| `gateway/apinto/entity/worker.go` | L59 |
| `gateway/apinto/entity/application.go` | L22 |
| `gateway/apinto/driver/api.go` | L40 |
| `gateway/apinto/entity/service.go` | L37 |
| `gateway/apinto/hash.go` | L58 |

</details>

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "前端新增節點 IP Port 控制器處理" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `controller/service/iml.go` | L482-553 |
| `controller/ai-api/iml.go` | L25-93 |
| `controller/service/iml.go` | L883-948 |
| `controller/service/iml.go` | L549-619 |
| `controller/service/iml.go` | L773-853 |
| `controller/router/router.go` | L47 |
| `controller/ai/controller.go` | L38 |
| `controller/mcp/iml.go` | L52 |
| `controller/service/iml.go` | L702-776 |
| `controller/ai/iml.go` | L60 |
| `controller/mcp/iml.go` | L97-148 |
| `controller/mcp/mcp.go` | L33 |
| `controller/mcp/iml.go` | L47-108 |
| `controller/system/import.go` | L228-284 |
| `controller/cluster/iml.go` | L66 |

</details>

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "cluster reset 更新節點地址" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `module/cluster/impl.go` | L45-119 |
| `service/cluster/cluster.go` | L264-354 |
| `controller/cluster/iml.go` | L66 |
| `service/cluster/cluster.go` | L233-273 |
| `module/cluster/dto/input.go` | L39 |
| `frontend/packages/core/src/pages/partitions/PartitionInsideClusterNode.tsx` | L8-93 |
| `module/cluster/cluster.go` | L21 |
| `service/cluster/cluster.go` | L183-238 |
| `stores/cluster/model.go` | L33-52 |
| `service/cluster/cluster.go` | L113-188 |
| `service/cluster/cluster.go` | L44 |
| `service/cluster/cluster.go` | L346-421 |
| `plugins/core/cluster.go` | L15 |
| `service/cluster/cluster.go` | L41-117 |
| `quick-start.sh` | L1397-1444 |

</details>

---

現在讓我查看前端相關的程式碼，了解前端如何處理節點新增：


---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "前端節點管理 新增節點 IP Port 輸入" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `frontend/packages/core/src/const/system/const.tsx` | L371-418 |
| `frontend/packages/core/src/pages/system/upstream/SystemInsideUpstreamContent.tsx` | L17-243 |
| `frontend/packages/core/src/pages/partitions/PartitionInsideClusterNode.tsx` | L8-93 |
| `frontend/packages/core/src/pages/mcpService/AddMcpKey.tsx` | L16-98 |
| `frontend/packages/core/src/pages/policy/FilterForm.tsx` | L201-356 |
| `frontend/packages/core/src/pages/common/ApiRequestSetting.tsx` | L13-107 |
| `frontend/packages/core/src/pages/aiSetting/contexts/AddProvider.tsx` | L16-86 |
| `frontend/packages/common/src/components/aoplatform/intelligent-plugin/IntelligentPluginList.tsx` | L84-433 |
| `frontend/packages/common/src/utils/validate.ts` | L2-40 |
| `frontend/packages/core/src/pages/system/api/SystemInsideApiProxy.tsx` | L8-88 |
| `frontend/packages/core/src/pages/aiSetting/contexts/AddProvider.tsx` | L12-84 |
| `frontend/packages/core/src/pages/aiSetting/ConfigureOllamaService.tsx` | L9-84 |
| `frontend/packages/core/src/pages/aiService/api/AiServiceInsideRouterCreate.tsx` | L50-522 |
| `frontend/packages/core/src/pages/partitions/PartitionInsideClusterNode.tsx` | L1-93 |
| `frontend/packages/core/src/pages/system/api/SystemInsideRouterCreate.tsx` | L27-344 |

</details>

---

Tool use: **read_file**

Read file: k8s_helm/apipark/values.yaml

---

Tool use: **codebase_search**

<details>
                <summary>Searched codebase "Apinto 配置 gateway listen_urls advertise_urls" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `k8s_helm/apipark/templates/configmap.yaml` | L61-97 |
| `quick-start.sh` | L1442-1498 |
| `docker-compose.yml` | L157-234 |
| `k8s_helm/apipark/values.yaml` | L88-199 |
| `gateway/apinto/entity/router.go` | L62 |
| `docker-compose-podman.yml` | L155-236 |
| `scripts/docker-compose.yml` | L60-95 |
| `gateway/apinto/plugin/apinto_plugin.yml` | L79 |
| `k8s_helm/apipark/templates/apinto-deployment.yaml` | L68 |
| `k8s_helm/apipark/templates/apinto-service.yaml` | L27 |
| `gateway/apinto/entity/service.go` | L37 |
| `gateway/apinto/project.go` | L48-119 |
| `gateway/apinto/client.go` | L83 |
| `module/ai-balance/iml.go` | L224-290 |
| `gateway/resource.go` | L83 |

</details>

---

現在讓我建立一個 TODO 清單來追蹤分析進度，然後提供完整的答案：


---

Tool use: **todo_write**

## Todo List

- [x] 分析 APIPark 如何判斷 Apinto IP 並寫入 cluster_node table
- [x] 分析前端新增節點 IP+Port 的執行流程
- [-] 分析為何服務地址顯示 port 80 而非 8099
- [ ] 提供完整的分析結果和解決方案

---

基於我對程式碼的深入分析，我來回答您的兩個問題：

## 1. APIPark 如何判斷 Apinto 的 IP 並寫入 cluster_node table

### 流程分析：

**步驟 1：通過 Admin API 獲取節點資訊**
```go
// service/cluster/cluster.go:127
apintoInfo, err := admin.Admin(address).Info(ctx)
```

APIPark 會向指定的 Apinto 管理地址（如 `10.4.0.148:9400`）發送 HTTP GET 請求到 `/system/info` 端點，獲取集群資訊。

**步驟 2：解析節點資訊**
```go
// gateway/admin/model.go:3-14
type Node struct {
    Id     string   `json:"id,omitempty"`
    Name   string   `json:"name,omitempty"`
    Peer   []string `json:"peer,omitempty"`    // 節點間通訊地址
    Admin  []string `json:"admin,omitempty"`   // 管理地址
    Server []string `json:"server,omitempty"`  // 服務地址
    Leader bool     `json:"leader,omitempty"`
}
```

**步驟 3：寫入資料庫**
```go
// service/cluster/cluster.go:168-188
nodeEn, addrEn := s.genNodeEntity(apintoInfo.Cluster, apintoInfo.Nodes)
err = s.store.Transaction(ctx, func(ctx context.Context) error {
    err := s.store.Insert(ctx, en)           // 插入 cluster 記錄
    err = s.nodeStore.Insert(ctx, nodeEn...) // 插入 cluster_node 記錄
    err = s.nodeAddressStore.Insert(ctx, addrEn...) // 插入節點地址記錄
})
```

## 2. 前端新增節點 IP+Port 的執行流程

### 完整流程：

**步驟 1：前端輸入**
- 用戶在前端輸入節點地址（如 `10.4.0.148:9400`）
- 前端會先進行連線測試

**步驟 2：API 調用**
```go
// controller/cluster/iml.go:24-28
func (p *imlCluster) ResetCluster(ctx *gin.Context, clusterId string, input *cluster_dto.ResetCluster) ([]*cluster_dto.Node, error) {
    return p.module.ResetCluster(ctx, clusterId, input.ManagerAddress)
}
```

**步驟 3：更新節點資訊**
```go
// service/cluster/cluster.go:272-351
func (s *imlClusterService) UpdateAddress(ctx context.Context, id string, address string) ([]*Node, error) {
    info, err := admin.Admin(address).Info(ctx) // 重新獲取節點資訊
    // 刪除舊的節點記錄
    // 插入新的節點記錄
}
```

## 3. 為何服務地址顯示 port 80 而非 8099

### 問題根源分析：

**Apinto 配置問題：**
從 `k8s_helm/apipark/templates/configmap.yaml` 可以看到：

```yaml
gateway:
  advertise_urls: # 轉發服務的廣播地址
    - http://0.0.0.0:8099
  listen_urls: # 轉發服務的監聽地址
    - http://0.0.0.0:8099
```

**問題在於：**
1. **配置不完整**：Apinto 的 `advertise_urls` 和 `listen_urls` 都設定為 `0.0.0.0:8099`，這會導致 Apinto 無法正確廣播其實際的外部 IP 地址。

2. **缺少外部 IP 配置**：在 K8s 環境中，Apinto 需要知道其外部可訪問的 IP 地址才能正確廣播。

### 解決方案：


---

Tool use: **todo_write**

## Todo List

- [x] 分析 APIPark 如何判斷 Apinto IP 並寫入 cluster_node table
- [x] 分析前端新增節點 IP+Port 的執行流程
- [x] 分析為何服務地址顯示 port 80 而非 8099
- [x] 提供完整的分析結果和解決方案

---

**修改 Apinto 配置：**

1. **更新 values.yaml**：
```yaml
apinto:
  service:
    type: NodePort  # 改為 NodePort
    nodePort: 8099  # 新增 NodePort 配置
```

2. **更新 configmap.yaml**：
```yaml
gateway:
  advertise_urls: # 轉發服務的廣播地址
    - http://{{ .Values.apinto.service.nodePort }}:8099  # 使用實際的外部 IP
  listen_urls: # 轉發服務的監聽地址
    - http://0.0.0.0:8099
```

3. **或者使用 LoadBalancer**：
```yaml
apinto:
  service:
    type: LoadBalancer
    port: 8099
```

### 總結：

1. **APIPark 通過 Admin API** (`/system/info`) 獲取 Apinto 節點資訊，包含管理地址、服務地址和節點通訊地址。

2. **前端新增節點流程**：輸入地址 → 測試連線 → 調用 ResetCluster API → 重新獲取節點資訊 → 更新資料庫。

3. **Port 80 問題**：由於 Apinto 配置中 `advertise_urls` 設定不當，導致廣播的服務地址不正確。需要正確配置外部 IP 和端口映射。

建議檢查 Apinto 的實際配置檔案，確保 `advertise_urls` 指向正確的外部可訪問地址，而不是 `0.0.0.0`。

---

_**User (2025-10-02 00:38Z)**_

- "在 K8s 環境中，Apinto 需要知道其外部可訪問的 IP 地址才能正確廣播。" 外部可訪問IP 指的是 APIPark 的連線IP 嗎? (EX:192.168.31.180:8288)
- @configmap.yaml 要如何修改? 外部可訪問的 IP 地址=192.168.31.180

---

_**Assistant (default)**_

您問得很好！讓我澄清一下外部可訪問 IP 的概念，並提供正確的修改方案。

## 外部可訪問 IP 的定義

**不是** APIPark 的連線 IP（192.168.31.180:8288），而是 **Apinto Gateway 的外部可訪問 IP**。

在 K8s 環境中：
- **APIPark 管理介面**：192.168.31.180:31288（NodePort）
- **Apinto Gateway 服務**：192.168.31.180:8099（需要配置 NodePort）

## 問題分析

目前的 `configmap.yaml` 配置有問題：

```yaml
gateway:
  advertise_urls: # 轉發服務的廣播地址
    - http://0.0.0.0:8099  # ❌ 錯誤：0.0.0.0 無法被外部訪問
  listen_urls: # 轉發服務的監聽地址
    - http://0.0.0.0:8099  # ✅ 正確：內部監聽
```

## 解決方案

### 1. 首先修改 `values.yaml`，為 Apinto 添加 NodePort：


---

Tool use: **read_file**

Read file: k8s_helm/apipark/values.yaml

---

很好！我看到 `values.yaml` 已經配置了 Apinto 的 NodePort 為 31899。現在需要修改 `configmap.yaml`：

### 2. 修改 `configmap.yaml`：


---

Tool use: **search_replace**


<details><summary>Edit file: k8s_helm/apipark/templates/configmap.yaml</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -68,10 +68,10 @@
      client:
        advertise_urls: # open api 服務的廣播位址
-         - http://0.0.0.0:9400
+         - http://192.168.31.180:9400
        listen_urls: # open api 服務的監聽位址
          - http://0.0.0.0:9400
      gateway:
        advertise_urls: # 轉送服務的廣播位址
-         - http://0.0.0.0:8099
+         - http://192.168.31.180:31899
        listen_urls: # 轉送服務的監聽位址
          - http://0.0.0.0:8099
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -80,5 +80,5 @@
          - http://0.0.0.0:9401
        advertise_urls: # 節點通訊廣播位址
-         - http://0.0.0.0:9401
+         - http://192.168.31.180:9401
  
    # MySQL Initialization Script
```

</details>

---

## 修改說明

### 關鍵變更：

1. **client.advertise_urls**：`http://192.168.31.180:9400`
   - 這是 APIPark 連接到 Apinto 管理介面的地址
   - 對應 APIPark 中輸入的節點地址

2. **gateway.advertise_urls**：`http://192.168.31.180:31899`
   - 這是 Apinto Gateway 對外提供服務的地址
   - 使用 NodePort 31899（對應內部端口 8099）

3. **peer.advertise_urls**：`http://192.168.31.180:9401`
   - 這是節點間通訊的地址

### 端口對應關係：

| 服務 | 內部端口 | 外部端口 (NodePort) | 用途 |
|------|----------|-------------------|------|
| APIPark | 8288 | 31288 | 管理介面 |
| Apinto Admin | 9400 | 9400 | 管理 API |
| Apinto Gateway | 8099 | 31899 | 轉發服務 |
| Apinto Peer | 9401 | 9401 | 節點通訊 |

## 驗證步驟

修改後，重新部署：

```bash
# 重新部署
helm upgrade apipark ./k8s_helm/apipark -n apipark

# 檢查 Apinto 配置
kubectl get configmap apipark-config -o yaml

# 檢查服務狀態
kubectl get svc -n apipark
```

這樣修改後，當您在 APIPark 前端輸入 `192.168.31.180:9400` 作為節點地址時，Apinto 會正確廣播其服務地址為 `192.168.31.180:31899`，而不是 port 80。

---

