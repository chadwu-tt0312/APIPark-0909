<!-- Generated by SpecStory -->

# 分析添加 REST 服務流程 (2025-09-09 01:28Z)

_**User (2025-09-09 01:28Z)**_

目前"添加 REST 服務"時需要
  1. 選擇 OpenAPI 文件(上傳檔案)
  2. 選擇所屬團隊

- 請分析並提供完整"添加 REST 服務"的流程(包含將資料新增到資料庫)。
- 然後與我討論如何修改成"批量添加 REST 服務"(原本一次上傳一個 OpenAPI 文件，變成一次可上傳多個文件)

---

_**Assistant**_

我來分析"添加 REST 服務"的完整流程，並與您討論如何修改成批量添加功能。


---

## Todo List

- [-] 分析添加 REST 服務的完整流程
- [ ] 找到 OpenAPI 文件上傳相關代碼
- [ ] 找到團隊選擇相關代碼
- [ ] 找到資料庫新增操作
- [ ] 設計批量上傳功能方案

---

<details>
                <summary>Searched codebase "添加 REST 服務 OpenAPI 文件上傳流程" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `controller/service/iml.go` | L307-383 |
| `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx` | L10-121 |
| `frontend/packages/core/src/pages/system/api/SystemInsideApiDocument.tsx` | L16-221 |
| `controller/router/iml.go` | L53-83 |
| `controller/service/iml.go` | L378-475 |
| `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx` | L13-123 |
| `module/ai-api/iml.go` | L44-96 |
| `service/api-doc/service.go` | Lundefined-64 |
| `mcp-server/openapi.go` | Lundefined-83 |
| `controller/service/iml.go` | L661-725 |
| `plugins/core/service.go` | Lundefined-24 |
| `plugins/core/service.go` | L34-48 |
| `mcp-server/server.go` | L143-170 |
| `plugins/openapi/mcp.go` | L30-48 |
| `mcp-server/server.go` | Lundefined-74 |

</details>

---

<details>
                <summary>Searched codebase "OpenAPI 文件上傳處理" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `controller/router/iml.go` | L53-83 |
| `frontend/packages/core/src/pages/system/api/SystemInsideApiDocument.tsx` | L16-221 |
| `controller/service/iml.go` | L307-383 |
| `mcp-server/openapi.go` | Lundefined-83 |
| `controller/service/iml.go` | L378-475 |
| `service/api-doc/service.go` | Lundefined-64 |
| `plugins/openapi/check.go` | Lundefined-48 |
| `module/ai-api/iml.go` | L44-96 |
| `mcp-server/server.go` | L143-170 |
| `plugins/openapi/check.go` | L42-83 |
| `plugins/openapi/mcp.go` | Lundefined-34 |
| `plugins/openapi/plugin.go` | Lundefined-35 |
| `mcp-server/server.go` | Lundefined-74 |
| `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx` | L13-123 |
| `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx` | L10-121 |

</details>

---

<details>
                <summary>Searched codebase "團隊選擇 team selection" • **13** results</summary>
            
| File | Lines |
|------|-------|
| `frontend/packages/core/src/pages/guide/LocalAiDeploy.tsx` | L11-198 |
| `frontend/packages/core/src/pages/guide/deployModelUtil.ts` | Lundefined-53 |
| `frontend/packages/core/src/pages/aiSetting/AiSettingModal.tsx` | L24-440 |
| `frontend/packages/market/src/pages/serviceHub/management/ServiceHubManagement.tsx` | L19-348 |
| `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx` | L13-123 |
| `frontend/packages/core/src/pages/team/TeamInsideMember.tsx` | L56-421 |
| `frontend/packages/core/src/pages/system/SystemConfig.tsx` | L40-691 |
| `frontend/packages/market/src/pages/serviceHub/management/ManagementConfig.tsx` | L30-262 |
| `stores/team/model.go` | Lundefined-37 |
| `module/my-team/iml.go` | L130-193 |
| `module/my-team/iml.go` | L185-267 |
| `frontend/packages/core/src/pages/team/TeamConfig.tsx` | L21-244 |
| `frontend/packages/core/src/pages/team/TeamInsideMember.tsx` | L56-422 |

</details>

---

## Todo List

- [x] 分析添加 REST 服務的完整流程
- [x] 找到 OpenAPI 文件上傳相關代碼
- [x] 找到團隊選擇相關代碼
- [-] 找到資料庫新增操作
- [ ] 設計批量上傳功能方案

---

<details>
                <summary>Searched codebase "service module Create 資料庫新增服務" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `module/service/iml.go` | L653-715 |
| `module/service/iml.go` | L710-786 |
| `module/service/iml.go` | L1187-1247 |
| `module/service/dto/input.go` | Lundefined-65 |
| `module/service/iml.go` | L779-853 |
| `module/service/module.go` | Lundefined-48 |
| `module/service/iml.go` | L849-907 |
| `module/service/dto/output.go` | L91-128 |
| `module/service/iml.go` | L954-1030 |
| `module/service/iml.go` | L1026-1057 |
| `module/service/module.go` | L45-76 |
| `module/service/iml.go` | Lundefined-77 |
| `module/service/module.go` | L72-104 |
| `module/service/iml.go` | L591-661 |
| `module/service/iml.go` | L256-342 |

</details>

---

<details>
                <summary>Searched codebase "api doc module UpdateDoc 資料庫更新" • **5** results</summary>
            
| File | Lines |
|------|-------|
| `module/api-doc/api_doc.go` | Lundefined-57 |
| `module/api-doc/dto/input.go` | Lundefined-5 |
| `module/api-doc/iml.go` | Lundefined-19 |
| `module/api-doc/api_doc.go` | L50-74 |
| `module/api-doc/dto/output.go` | Lundefined-8 |

</details>

---

<details>
                <summary>Searched codebase "router module Create 路由建立" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `module/router/router.go` | Lundefined-55 |
| `module/router/dto/input.go` | Lundefined-65 |
| `module/router/iml.go` | L246-301 |
| `module/router/iml.go` | L219-253 |
| `module/router/iml.go` | Lundefined-70 |
| `module/router/iml.go` | L297-364 |
| `module/router/dto/output.go` | Lundefined-63 |
| `module/router/filter.go` | Lundefined-84 |
| `module/router/iml.go` | L171-224 |
| `module/router/iml.go` | L358-376 |
| `module/router/iml.go` | L121-176 |
| `module/router/iml.go` | L64-129 |
| `module/router/dto/input.go` | L61-109 |
| `module/router/dto/output.go` | L57-114 |
| `module/router/dto/output.go` | L110-125 |

</details>

---

## Todo List

- [x] 分析添加 REST 服務的完整流程
- [x] 找到 OpenAPI 文件上傳相關代碼
- [x] 找到團隊選擇相關代碼
- [x] 找到資料庫新增操作
- [-] 設計批量上傳功能方案

---

Read file: undefined

---

## Todo List

- [x] 分析添加 REST 服務的完整流程
- [x] 找到 OpenAPI 文件上傳相關代碼
- [x] 找到團隊選擇相關代碼
- [x] 找到資料庫新增操作
- [x] 設計批量上傳功能方案

---

根據我的分析，以下是"添加 REST 服務"的完整流程：

## 目前"添加 REST 服務"的完整流程

### 1. 前端流程
**位置：** `frontend/packages/core/src/pages/guide/RestAIDeploy.tsx`

1. **文件上傳**：
   - 使用 `Upload` 組件，限制只能上傳 `.json` 和 `.yaml` 文件
   - 設定 `multiple: false, maxCount: 1`，只允許單個文件上傳
   - 文件驗證通過後，存儲在表單的 `key` 欄位

2. **團隊選擇**：
   - 通過 `getTeamOptionList()` 獲取可選團隊列表
   - 使用 `Select` 組件讓用戶選擇所屬團隊
   - 預設選擇第一個團隊

3. **提交處理**：
   - 表單驗證通過後，調用 `deployRestServer()` 函數
   - 建立 `FormData` 包含：`file`、`type: 'swagger'`、`team`
   - 發送 POST 請求到 `quick/service/rest` 端點

### 2. 後端流程
**位置：** `controller/service/iml.go` 的 `QuickCreateRestfulService` 方法

1. **文件處理**：
   - 接收 `file` 表單文件
   - 讀取文件內容到記憶體
   - 驗證文件類型（支援 "swagger" 或空值）

2. **資料庫事務處理**：
   - 在事務中執行以下操作：
   
   **a. 建立服務記錄**：
   ```go
   s, err := i.module.Create(ctx, teamId, &service_dto.CreateService{
       Id:           uuid.NewString(),
       Name:         "Restful Service By Swagger",
       Prefix:       prefix,  // 格式: /{id前8位}
       Description:  "Auto create by upload swagger",
       ServiceType:  "public",
       State:        "normal",
       Catalogue:    catalogueInfo.Id,
       ApprovalType: "auto",
       Kind:         "rest",
   })
   ```

   **b. 更新 API 文檔**：
   ```go
   _, err = i.apiDocModule.UpdateDoc(ctx, s.Id, &api_doc_dto.UpdateDoc{
       Id:      s.Id,
       Content: string(content),  // OpenAPI 文件內容
   })
   ```

   **c. 建立路由**：
   ```go
   _, err = i.routerModule.Create(ctx, s.Id, &router_dto.Create{
       Id:          uuid.NewString(),
       Path:        path + "*",  // 萬用字元路由
       Methods:     []string{http.MethodGet, http.MethodPost, ...},
       Description: "auto create by create service",
       Protocols:   []string{"http", "https"},
       Proxy: &router_dto.InputProxy{
           Path:    path,
           Timeout: 30000,
           Retry:   0,
       },
   })
   ```

   **d. 訂閱應用**：
   - 搜尋團隊下的所有應用
   - 為每個應用添加訂閱者

### 3. 資料庫操作
- **服務表**：透過 `serviceService.Create()` 新增服務記錄
- **API 文檔表**：透過 `apiDocService.UpdateDoc()` 儲存 OpenAPI 內容
- **API 表**：透過 `apiService.Create()` 建立路由記錄
- **訂閱表**：透過 `subscribeModule.AddSubscriber()` 建立訂閱關係

---

## 批量添加 REST 服務的修改方案

### 方案一：前端批量上傳 + 後端循環處理

**優點**：實現簡單，復用現有邏輯
**缺點**：事務處理複雜，部分失敗時回滾困難

#### 前端修改：
```typescript
// 修改 Upload 組件支援多文件
const uploadProps: UploadProps = {
  accept: '.json,.yaml',
  name: 'files',  // 改為 files
  multiple: true,  // 改為 true
  maxCount: 10,    // 設定最大上傳數量
  beforeUpload: (file) => {
    // 處理多個文件
    return false
  }
}

// 修改提交邏輯
const deployRestServer = async (files: File[]) => {
  const formData = new FormData()
  files.forEach(file => {
    formData.append('files', file)
  })
  formData.append('type', 'swagger')
  formData.append('team', form.getFieldValue('team'))
  
  // 發送到新的批量端點
  fetchData('quick/service/rest/batch', {
    method: 'POST',
    body: formData
  })
}
```

#### 後端修改：
```go
// 新增批量處理方法
func (i *imlServiceController) BatchCreateRestfulService(ctx *gin.Context) error {
    form, err := ctx.MultipartForm()
    if err != nil {
        return err
    }
    
    files := form.File["files"]
    teamId := ctx.PostForm("team")
    
    var results []BatchResult
    var errors []string
    
    for _, fileHeader := range files {
        result := i.processSingleFile(ctx, fileHeader, teamId)
        results = append(results, result)
        if result.Error != "" {
            errors = append(errors, result.Error)
        }
    }
    
    // 返回批量處理結果
    return ctx.JSON(200, gin.H{
        "success": len(errors) == 0,
        "results": results,
        "errors": errors,
    })
}
```

### 方案二：前端並行上傳 + 後端單個處理

**優點**：事務簡單，錯誤處理清晰
**缺點**：網路請求較多

#### 前端修改：
```typescript
const deployRestServer = async (files: File[]) => {
  const promises = files.map(file => 
    deploySingleRestServer(file, form.getFieldValue('team'))
  )
  
  const results = await Promise.allSettled(promises)
  
  // 處理結果
  const successCount = results.filter(r => r.status === 'fulfilled').length
  const errorCount = results.filter(r => r.status === 'rejected').length
  
  message.info(`成功上傳 ${successCount} 個，失敗 ${errorCount} 個`)
}
```

### 方案三：ZIP 文件上傳 + 後端解壓處理

**優點**：減少網路傳輸，支援大量文件
**缺點**：需要額外的解壓邏輯

#### 實現要點：
1. 前端將多個 OpenAPI 文件打包成 ZIP
2. 後端接收 ZIP 文件並解壓
3. 對每個解壓後的文件執行現有的單個處理邏輯

---

## 建議的實現方案

我建議採用**方案一**，原因如下：

1. **復用現有邏輯**：可以最大程度復用現有的 `QuickCreateRestfulService` 邏輯
2. **用戶體驗好**：一次操作完成多個文件上傳
3. **實現相對簡單**：主要是前端 UI 調整和後端循環處理

### 具體實現步驟：

1. **前端修改**：
   - 修改 `Upload` 組件支援多文件選擇
   - 調整表單驗證邏輯
   - 新增批量上傳進度顯示

2. **後端修改**：
   - 新增 `BatchCreateRestfulService` 方法
   - 復用現有的單個文件處理邏輯
   - 新增批量處理結果回傳

3. **錯誤處理**：
   - 部分文件失敗時，繼續處理其他文件
   - 回傳詳細的成功/失敗信息
   - 提供重試機制

您覺得這個方案如何？需要我詳細說明任何部分的實現細節嗎？

---

